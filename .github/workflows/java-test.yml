# This workflow builds, tests, and analyzes the Java project.
# It includes steps for caching, code quality analysis, security scanning,
# and creating releases.
name: Java CI/CD

# --- TRIGGERS ---
# This workflow runs on pushes and pull requests to the master branch,
# and also allows for manual runs.
on:
  push:
    branches: [ "master" ]
    tags:
      - 'v*' # Also run on tags starting with 'v' for releases
  pull_request:
    branches: [ "master" ]
  workflow_dispatch:

# --- JOBS ---
jobs:
  # --- BUILD & TEST JOB ---
  # This job builds the project, runs tests, and performs analysis.
  # It runs on a matrix of Java versions.
  build:
    name: Build, Test, and Analyze
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        # Run the job for these Operating Systems and Java versions
        os: [ 'ubuntu-latest', 'windows-latest', 'macos-latest' ]
        java: [ '11', '17' ]

    steps:
      # --- 1. CHECKOUT CODE ---
      - name: Checkout repository
        uses: actions/checkout@v4

      # --- 2. SET UP JAVA & CACHE ---
      # Sets up the specified Java version and caches Maven dependencies
      # to speed up subsequent builds.
      - name: Set up JDK ${{ matrix.java }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ matrix.java }}
          distribution: 'temurin'
          cache: 'maven'

      # --- 3. INITIALIZE CODEQL ---
      # Sets up CodeQL for static analysis security testing (SAST).
      # This helps find security vulnerabilities in the code.
      - name: Initialize CodeQL
        if: matrix.os == 'ubuntu-latest'
        uses: github/codeql-action/init@v3
        with:
          languages: 'java'

      # --- 4. BUILD, TEST, AND ANALYZE ---
      # This single command does the following:
      # - 'checkstyle:check': Runs Checkstyle to enforce coding standards.
      # - 'test': Compiles the code and runs all tests. JaCoCo agent prepares coverage data.
      # - 'package': Packages the compiled code into a JAR file.
      # - '-B': Runs Maven in non-interactive (batch) mode.
      - name: Build, Test, and Analyze with Maven
        run: mvn -B clean install checkstyle:check

      # --- 5. PERFORM CODEQL ANALYSIS ---
      # Finalizes the CodeQL scan and uploads the results to GitHub Security.
      - name: Perform CodeQL Analysis
        if: matrix.os == 'ubuntu-latest'
        uses: github/codeql-action/analyze@v3

      # --- 6. UPLOAD TEST RESULTS ---
      # Uploads the surefire reports as build artifacts.
      # This allows for reviewing test results for each OS/Java version.
      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.os }}-${{ matrix.java }}
          path: target/surefire-reports

      # --- 7. UPLOAD COVERAGE REPORT ---
      # Uploads the test coverage report generated by JaCoCo to Codecov.
      # This requires a CODECOV_TOKEN secret to be set in the repository settings.
      - name: Upload coverage to Codecov
        if: matrix.os == 'ubuntu-latest' && matrix.java == '17'
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }} # Recommended: create this secret in repo settings
          fail_ci_if_error: true

      # --- 8. UPLOAD ARTIFACT ---
      # Uploads the built JAR file as a build artifact.
      # This allows the 'release' job to download and use it.
      - name: Upload build artifact
        if: matrix.os == 'ubuntu-latest' && matrix.java == '17'
        uses: actions/upload-artifact@v4
        with:
          name: invaders-jar
          path: target/invaders-*.jar

  # --- RELEASE JOB ---
  # This job creates a GitHub Release when a new tag is pushed.
  release:
    name: Create Release
    needs: build # This job depends on the 'build' job completing successfully
    runs-on: ubuntu-latest
    # Only run this job if a tag was pushed
    if: startsWith(github.ref, 'refs/tags/')

    steps:
      # --- 1. DOWNLOAD ARTIFACT ---
      # Downloads the JAR file that was built and uploaded by the 'build' job.
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: invaders-jar

      # --- 2. CREATE GITHUB RELEASE ---
      # Creates a new release on GitHub, using the tag name.
      # It attaches the downloaded JAR file as a release asset.
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: invaders-*.jar
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}